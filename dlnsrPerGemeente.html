<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Woonplaats deelnemers gezinsvakanties vzw Gandalf</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        #map {
            height: 100vh;
            width: 100%;
        }
        
        .legend {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        @media (max-width: 768px) {
            .legend {
                padding: 8px;
                font-size: 12px;
            }
            
            .legend h4 {
                font-size: 13px;
                margin: 0 0 6px 0;
            }
            
            .legend-item {
                margin: 4px 0;
                font-size: 11px;
            }
            
            .legend-circle {
                margin-right: 6px;
            }
            
            .info-panel {
                padding: 10px;
                max-width: 200px;
            }
            
            .info-panel h3 {
                font-size: 16px;
                margin: 0 0 8px 0;
            }
            
            .info-panel p {
                font-size: 12px;
                margin: 3px 0;
            }
        }
        
        .legend h4 {
            margin: 0 0 10px 0;
            color: #333;
            font-weight: 600;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin: 8px 0;
            font-size: 13px;
            color: #555;
        }
        
        .legend-circle {
            border-radius: 50%;
            margin-right: 10px;
            border: 2px solid #fff;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }
        
        .info-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            z-index: 1000;
            max-width: 300px;
        }
        
        .info-panel h3 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 18px;
        }
        
        .info-panel p {
            margin: 5px 0;
            color: #666;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <div class="info-panel">
        <h3>üèõÔ∏è Aantal gezinnen per gemeente</h3>
        <p>Klik op de bubbels om de details te zien</p>
        <p>De grootte duidt het aantal deelnemende gezinnen aan</p>
        <p><strong>Total:</strong> <span id="total-count">0</span> gezinnen</p>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/topojson/3.0.2/topojson.min.js"></script>
    <script>
        // Wait for Leaflet to load
        function initMap() {
            if (typeof L === 'undefined') {
                setTimeout(initMap, 100);
                return;
            }
            
        // Municipality data with corrected coordinates (West Flanders region)
        const municipalityData = {
            'Ardooie': { count: 1, lat: 50.976728, lng: 3.199116 }, // Corrected
            'Beernem': { count: 5, lat: 51.1347, lng: 3.3403 },
            'Blankenberge': { count: 15, lat: 51.3133, lng: 3.1317 },
            'Bredene': { count: 1, lat: 51.2489, lng: 2.9614 },
            'Brugge': { count: 40, lat: 51.2093, lng: 3.2247 },
            'De Haan': { count: 1, lat: 51.2833, lng: 3.0333 },
            'De Panne': { count: 2, lat: 51.0978, lng: 2.5931 },
            'Diksmuide': { count: 3, lat: 51.0333, lng: 2.8667 },
            'Ichtegem': { count: 21, lat: 51.0928306, lng: 3.0106116 }, // Corrected
            'Ieper': { count: 11, lat: 50.8503, lng: 2.8847 },
            'Ingelmunster': { count: 5, lat: 50.9167, lng: 3.2667 },
            'Izegem': { count: 9, lat: 50.9139, lng: 3.2167 },
            'Knokke-Heist': { count: 1, lat: 51.3500, lng: 3.2667 },
            'Koekelare': { count: 1, lat: 51.0908, lng: 2.9675 },
            'Koksijde': { count: 1, lat: 51.1200, lng: 2.6367 },
            'Kortemark': { count: 5, lat: 51.0272, lng: 3.0514 },
            'Kortrijk': { count: 1, lat: 50.8281, lng: 3.2648 },
            'Langemark-Poelkapelle': { count: 1, lat: 50.9167, lng: 2.9167 },
            'Ledegem': { count: 1, lat: 50.8642, lng: 3.1311 },
            'Lichtervelde': { count: 1, lat: 51.0311, lng: 3.1422 },
            'Menen': { count: 27, lat: 50.7972, lng: 3.1211 },
            'Moorslede': { count: 3, lat: 50.8833, lng: 3.0667 },
            'Oostende': { count: 16, lat: 51.2289, lng: 2.9181 },
            'Oostkamp': { count: 10, lat: 51.1558, lng: 3.2239 },
            'Poperinge': { count: 3, lat: 50.8547, lng: 2.7344 },
            'Roeselare': { count: 6, lat: 50.9464, lng: 3.1258 },
            'Ronse': { count: 1, lat: 50.7494, lng: 3.6003 },
            'Tielt': { count: 2, lat: 51.0000, lng: 3.3333 },
            'Torhout': { count: 3, lat: 51.0669, lng: 3.1019 },
            'Vleteren': { count: 1, lat: 50.929707, lng: 2.732738 }, // Corrected
            'Wervik': { count: 2, lat: 50.7831, lng: 3.0397 },
            'Wingene': { count: 16, lat: 51.05865, lng: 3.274799 }, // Corrected
            'Zonnebeke': { count: 2, lat: 50.8667, lng: 2.9833 },
            'Zuienkerke': { count: 1, lat: 51.2833, lng: 3.1833 }
        };

        // Initialize map centered on West Flanders
        const map = L.map('map').setView([51.05, 3.1], 10);

        // Add tile layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors',
            opacity: 0.4
        }).addTo(map);

        // Color scale function
        function getColor(count) {
            if (count >= 30) return '#8B0000'; // Dark red for highest
            if (count >= 20) return '#DC143C'; // Crimson
            if (count >= 15) return '#FF4500'; // Orange red
            if (count >= 10) return '#FF6347'; // Tomato
            if (count >= 5) return '#FFA500';  // Orange
            return '#FFD700'; // Gold for lowest
        }

        // Size scale function
        function getRadius(count) {
            return Math.sqrt(count) * 5 + 5;
        }

        // Load municipality boundaries FIRST (so they appear below bubbles)
        const municipalityBoundariesUrl = 'https://raw.githubusercontent.com/bmesuere/belgium-topojson/master/source_data/Gemeenten.json';
        
        fetch(municipalityBoundariesUrl)
            .then(response => response.json())
            .then(data => {
                console.log('Municipality boundaries loaded');
                
                // Convert TopoJSON to GeoJSON
                const objectKey = Object.keys(data.objects)[0];
                const geojsonData = topojson.feature(data, data.objects[objectKey]);
                
                // Filter for West-Vlaanderen + Ronse
                const filteredFeatures = geojsonData.features.filter(feature => {
                    const props = feature.properties;
                    const municipalityName = (props.NAME_4 || '').toLowerCase().trim();
                    const provinceName = (props.NAME_2 || '').toLowerCase().trim();
                    
                    // Include all West-Vlaanderen municipalities OR specifically Ronse
                    return provinceName === 'west-vlaanderen' || 
                           provinceName === 'west vlaanderen' ||
                           municipalityName === 'ronse';
                });

                console.log(`Found ${filteredFeatures.length} municipalities (West-Vlaanderen + Ronse)`);

                // Add municipality boundaries (no popups, just visual boundaries)
                L.geoJSON(filteredFeatures, {
                    style: {
                        color: '#2E7D32',
                        weight: 1.5,
                        opacity: 0.7,
                        fillColor: '#4CAF50',
                        fillOpacity: 0.08,
                        dashArray: '4, 4'
                    },
                    onEachFeature: function(feature, layer) {
                        // Remove popup - only keep hover effects
                        layer.on('mouseover', function() {
                            layer.setStyle({
                                weight: 2,
                                opacity: 0.9,
                                fillOpacity: 0.15
                            });
                        });
                        
                        layer.on('mouseout', function() {
                            layer.setStyle({
                                weight: 1.5,
                                opacity: 0.7,
                                fillOpacity: 0.08
                            });
                        });
                    }
                }).addTo(map);

                // Now add the data bubbles ON TOP of boundaries
                addDataBubbles();
            })
            .catch(error => {
                console.log('Could not load boundaries:', error);
                // If boundaries fail, just add bubbles
                addDataBubbles();
            });

        // Function to add data bubbles (will be on top layer)
        function addDataBubbles() {
            let totalCount = 0;
            
            Object.entries(municipalityData).forEach(([name, data]) => {
                totalCount += data.count;
                
                const circle = L.circleMarker([data.lat, data.lng], {
                    radius: getRadius(data.count),
                    fillColor: getColor(data.count),
                    color: '#fff',
                    weight: 2,
                    opacity: 0.9,
                    fillOpacity: 0.8
                });

                // Popup content for data bubbles
                const popupContent = `
                    <div style="text-align: center; min-width: 150px;">
                        <h3 style="margin: 0 0 10px 0; color: #333; font-size: 16px;">${name}</h3>
                        <div style="font-size: 24px; font-weight: bold; color: ${getColor(data.count)};">${data.count}</div>
                        <div style="color: #666; font-size: 12px; margin-top: 5px;">gezinnen</div>
                    </div>
                `;

                circle.bindPopup(popupContent);
                
                // Add hover effects
                circle.on('mouseover', function(e) {
                    this.setStyle({
                        weight: 3,
                        fillOpacity: 1
                    });
                });

                circle.on('mouseout', function(e) {
                    this.setStyle({
                        weight: 2,
                        fillOpacity: 0.8
                    });
                });

                circle.addTo(map);
            });

            // Update total count
            document.getElementById('total-count').textContent = totalCount;

            // Add legend
            const legend = L.control({position: 'bottomright'});
            legend.onAdd = function() {
                const div = L.DomUtil.create('div', 'legend');
                div.innerHTML = `
                    <h4>Gezinnen per Gemeente</h4>
                    <div class="legend-item">
                        <div class="legend-circle" style="width: 25px; height: 25px; background-color: #8B0000;"></div>
                        <span>30+ gezinnen</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-circle" style="width: 22px; height: 22px; background-color: #DC143C;"></div>
                        <span>20-29 gezinnen</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-circle" style="width: 19px; height: 19px; background-color: #FF4500;"></div>
                        <span>15-19 gezinnen</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-circle" style="width: 16px; height: 16px; background-color: #FF6347;"></div>
                        <span>10-14 gezinnen</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-circle" style="width: 13px; height: 13px; background-color: #FFA500;"></div>
                        <span>5-9 gezinnen</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-circle" style="width: 10px; height: 10px; background-color: #FFD700;"></div>
                        <span>1-4 gezin(nen)</span>
                    </div>
                `;
                return div;
            };
            legend.addTo(map);
        }
        }
        
        // Initialize when page loads
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initMap);
        } else {
            initMap();
        }
    </script>
</body>
</html>